function changeScreens(){var e=document.getElementById("screen1"),t=document.getElementById("screen2"),a=document.getElementById("move");if("inline"==e.style.display){if(""==document.getElementById("bodymass").value)throw alert("Please enter a body mass (kg)"),new Error("Please enter a body mass");if(!$('input[name="sex"]:checked').val())throw alert("Please select patient sex"),new Error("Please select patient sex");if(sex=$('input[name="sex"]:checked').val(),setMass(document.getElementById("bodymass").value),(r=document.getElementById("title")).innerHTML="Anaerobic capacity / MAOD (screen 2)",e.style.display="none",t.style.display="inline",a.value="Previous Screen","speed"==(workloadUnits=$('input[name="workloadUnits"]:checked').val()))(n=document.getElementById("reqWUnits")).innerHTML="<strong>Required Speed (kph)</strong>";else{var n=document.getElementById("reqWUnits");n.innerHTML="<strong>Required Power (W)</strong>"}}else{var r=document.getElementById("title");r.innerHTML="Anaerobic capacity / MAOD (screen 1)",e.style.display="inline",t.style.display="none",a.value="Next Screen"}}function getList(e){var t=0;input=document.getElementsByClassName(e);for(var a=0;a<input.length;a++)input[a].value||t++;if(t==input.length)throw new Error("No input values for X, nothing to be drawn.");"x"==e?xs1=copy(input):"x2"==e?xs2=copy(input):"y"==e?ys1=copy(input):"y2"==e&&(ys2=copy(input))}function freeButton(){$("#nxtbtn").css("visibility","visible"),$("#clearbtn").css("visibility","visible")}function copy(e){for(var t=[],a=0;a<e.length;a++)e[a].value&&""!=e[a].value&&(t[a]=parseFloat(e[a].value));return t}function getMaximumValue(e){for(var t=-(Math.pow(2,53)-1),a=0;a<e.length;a++)e[a]>=t&&(t=e[a]);return t}function getMinimumValue(e){for(var t=Math.pow(2,53)-1,a=0;a<e.length;a++)e[a]<=t&&(t=e[a]);return t}function clearGraph(e,t){if($("#"+e).empty(),"graphS1"==e){if(xInput=0,yInput=0,xs1=[],ys1=[],ny=0,nx=0,count=0,sumX=0,sumY=0,sumY2=0,sumX2=0,sumXY=0,$("#xAxisLabel").text("Workload (Kph)"),$("#xAxisLabel").css("opacity","0.0"),$("#yAxisLabel").text(""),$("#results").html('<strong><div style="margin-left: -73px;">Y = </div></strong><div style="margin-left: -120px;"><strong>R&sup2;= </strong></div>'),$("#results").css("opacity","0.0"),xFinal=[],yFinal=[],lineY1=0,lineY2=0,lineX1=0,lineX=0,workloadData=[],t){var a=document.getElementsByClassName("x"),n=document.getElementsByClassName("y");document.getElementById("bodymass").value="",document.getElementById("name").value="",document.getElementById("female").checked=!1,document.getElementById("male").checked=!1,document.getElementById("speed").checked=!1,document.getElementById("power").checked=!1;for(r=0;r<a.length;r++)a[r].value="",n[r].value=""}}else if("graphS2"==e&&(vo2MaxValues=[],xs2=[],ys2=[],$("#xAxisLabel2").text("Graph"),$("#xAxisLabel2").css("opacity","0.0"),$("#yAxisLabel2").text(""),$("#results2").text("Result"),$("#results2").css("opacity","0.0"),$("#graphS3").empty(),$("#percent").css("opacity","0.0"),$("#percent").text("99.9%"),$("#yAxisLabel3").text(""),t)){for(var n=document.getElementsByClassName("y2"),r=0;r<n.length;r++)n[r].value="";document.getElementById("Vmax").value="",document.getElementById("supramaximal").value="",document.getElementById("reqworkload").value="",vMax=0,workrate=0}}function multiplySum(e,t){for(var a=0,n=0;n<e.length;n++)a+=e[n]*t[n];return a}function sum(e){for(var t=0,a=0;a<e.length;a++)t+=parseFloat(e[a]);return t}function regression(e){return slope*e+intercept}function s1Input(){if(""==document.getElementById("bodymass").value)throw alert("Please enter a body mass (kg)"),new Error("Please enter a body mass");if(!$('input[name="sex"]:checked').val())throw alert("Please select patient sex"),new Error("Please select patient sex");if(!$('input[name="workloadUnits"]:checked').val())throw alert("Please select workload units"),new Error("Please select workload units");clearGraph("graphS1",!1),getList("x"),getList("y"),sumX=sum(xs1),sumY=sum(ys1),sumX2=multiplySum(xs1,xs1),sumXY=multiplySum(xs1,ys1),sumY2=multiplySum(ys1,ys1),slope=(xs1.length*sumXY-sumX*sumY)/(xs1.length*sumX2-sumX*sumX),intercept=(sumY-slope*sumX)/xs1.length,lineX2=getMaximumValue(xs1),lineX1=getMinimumValue(xs1),maxY=getMaximumValue(ys1),lineY1=regression(0),lineY2=regression(lineX2);for(var e=0;e<xs1.length;e++)workloadData.push([xs1[e],ys1[e]]);if(xs1.length!=ys1.length||!ys1[0])throw alert("X-list does not match the Y-list"),new error("X-List does not match Y-list");count=xs1.length,firstGraph(),freeButton()}function firstGraph(){$("#xAxisLabel").css("opacity","1.0");var e,t,a={top:20,right:20,bottom:20,left:50},n=700-a.left-a.right,r=700-a.top-a.bottom;intercept>=0?(e=0,t=lineY1):(e=-intercept/slope,t=0);var s=[{x:e,y:t},{x:lineX2,y:lineY2}],l=workloadData,i=d3.scale.linear().domain([0,lineX2]).range([0,n]),o=d3.scale.linear().domain([0,5]).range([r,0]),c=d3.select("#graphS1").append("svg:svg").attr("width",n+a.right+a.left).attr("height",r+a.top+a.bottom).attr("class","chart").append("g").attr("transform","translate("+a.left+","+a.top+")").attr("width",n).attr("height",r).attr("class","main"),u=d3.svg.axis().scale(i).orient("bottom").innerTickSize(-r).outerTickSize(0).tickPadding(10);c.append("g").attr("transform","translate(0,"+r+")").attr("class","main axis date").call(u);var d=d3.svg.axis().scale(o).orient("left").innerTickSize(-n).outerTickSize(0).tickPadding(10);c.append("g").attr("transform","translate(0,0)").attr("class","main axis date").call(d);var m=c.append("svg:g"),p=d3.svg.line().x(function(e){return i(e.x)}).y(function(e){return o(e.y)}).interpolate("linear");m.append("svg:path").attr("d",p(s)).attr("stroke","#cec3e3").attr("stroke-width",2).attr("fill","none").append("svg:title").text(function(e){return"Y-Intercept: "+intercept+", Slope: "+slope}),m.selectAll("scatter-dots").data(l).enter().append("svg:circle").attr("cx",function(e,t){return i(e[0])}).attr("cy",function(e){return o(e[1])}).attr("r",5,5).append("svg:title").text(function(e){return e}),$("#results").css("opacity","1.0"),$("#results").html("<div style='margin-left: -73px; padding-left: 375px; text-align: left';><strong>Y = "+Math.round(1e3*slope)/1e3+"X + "+Math.round(1e3*intercept)/1e3+" <br />R&sup2;= "+correlation()+"</strong></div>"),"speed"==$('input[name="workloadUnits"]:checked').val()?$("#xAxisLabel").text("Workload (Kph)"):$("#xAxisLabel").text("Workload (W)"),$("#yAxisLabel").html("V0<sub>2</sub> (L/min)")}function s2Input(){if(""==document.getElementById("Vmax").value)throw alert("Please enter Estimated VO2max (L/min)"),new Error("Please enter a Estimated VO2max (L/min)");if(""==document.getElementById("supramaximal").value)throw alert("Please enter Supramaximal Workrate (%max)"),new Error("Please enter Supramaximal Workrate (%max)");reqSpeed(),clearGraph("graphS2",!1),getList("x2"),getList("y2");for(var e=0;e<xs2.length;e++)vo2MaxValues[e]={x:xs2[e],y:ys2[e]};secondGraph(),$("#xAxisLabel2").css("opacity","1")}function secondGraph(){var e={top:20,right:20,bottom:20,left:50},t=700-e.left-e.right,a=700-e.top-e.bottom,n=d3.scale.linear().domain([0,180]).range([0,t]),r=d3.scale.linear().domain([0,7]).range([a,0]),s=d3.select("#graphS2").append("svg:svg").attr("width",t+e.right+e.left).attr("height",a+e.top+e.bottom).attr("class","chart").append("g").attr("transform","translate("+e.left+","+e.top+")").attr("width",t).attr("height",a).attr("class","main"),l=d3.svg.axis().scale(n).orient("bottom").ticks(5).tickValues(d3.range(0,t,intervalLength)).innerTickSize(-a).outerTickSize(0).tickPadding(10);s.append("g").attr("transform","translate(0,"+a+")").attr("class","main axis date").call(l);var i=d3.svg.axis().scale(r).orient("left").ticks(14).innerTickSize(-t).outerTickSize(0).tickPadding(10);s.append("g").attr("transform","translate(0,0)").attr("class","y axis").call(i);var o=s.append("svg:g"),c=[{x:intervalLength*ys2.length,y:O2req}];o.selectAll(".bar2").data(c).enter().append("rect").attr("class","bar2").attr("x",1).attr("y",function(e){return r(e.y)-1}).attr("width",function(e){return n(e.x)-1}).attr("height",function(e){return a-r(e.y)}),o.selectAll(".bar").data(vo2MaxValues).enter().append("rect").attr("class","bar").attr("x",function(e){return n(e.x-intervalLength)}).attr("y",function(e){return r(e.y)-1}).attr("width",t/numIntervals).attr("height",function(e){return a-r(e.y)});var u=[{x:0,y:O2req},{x:180,y:O2req}],d=d3.svg.line().x(function(e){return n(e.x)}).y(function(e){return r(e.y)}).interpolate("linear");o.append("svg:path").attr("d",d(u)).attr("stroke","black").attr("stroke-width",1).attr("fill","none"),o.append("text").attr("transform","translate(5,"+r(u[1].y+.2)+")").attr("dy",".35em").attr("text-anchor","start").style("fill","black").style("font-weight","bold").text("Oxygen Required "+Math.round(100*O2req)/100+" L/min"),calcMAOD(),$("#results2").html("MOAD = <strong>"+maod+"</strong> mL O<sub>2</sub> eq/kg"),$("#results2").css("opacity","1.0"),$("#xAxisLabel2").text("Time Interval (s)"),$("#yAxisLabel2").html("V0<sub>2</sub> (L/min)")}function correlation(){var e=0,t=count*sumXY-sumX*sumY,a=Math.sqrt((count*sumX2-Math.pow(sumX,2))*(count*sumY2-Math.pow(sumY,2)));return e=Math.pow(t/a,2),(e=Math.round(1e3*e)/1e3)<.8&&alert("Please review the data you entered, it has a weak correlation."),e}function calcMAOD(){var e=0,t=0;t=60/intervalLength;for(var a=0;a<ys2.length;a++)e+=O2req-ys2[a];if(maod=e/t,maod*=1e3,!(maod=Math.round(maod/bodyMass*10)/10))throw alert("Unable to calculate MAOD - check your data input"),new Error("Unable to calculate MAOD");if(maod<0||maod>100)throw alert("MAOD outside of expected bounds - check your data input"),new Error("Unable to calculate MAOD");percentileGraph()}function adjIntervalTable(e){if(e.value<=totalTime&&180%e.value==0&&(e.value%10==0||e.value%15==0)||5==e.value){e.style.background="white";var t=document.getElementsByClassName("x2"),a=document.getElementsByClassName("y2");intervalLength=parseInt(e.value),numIntervals=totalTime/intervalLength;for(var n=0;n<=numIntervals;n++)a[n].value="",t[n].style.display="inline",a[n].style.display="inline",t[n].value=(n+1)*e.value;for(var r=numIntervals;r<=t.length;r++)a[n].value="",t[r].style.display="none",a[r].style.display="none"}else e.style.background="red"}function setMass(e){bodyMass=parseFloat(e)}function reqSpeed(){if(vo2max=parseFloat(document.getElementById("Vmax").value),workrate=parseFloat(document.getElementById("supramaximal").value),vo2max&&workrate)O2req=vo2max*workrate/100,reqwork=(O2req-intercept)/slope,(e=document.getElementById("reqworkload")).value=Math.round(10*reqwork)/10;else{var e=document.getElementById("reqworkload");e.value=""}}function percentileGraph(){var e=calcPercentile(sex),t={top:20,right:20,bottom:20,left:70},a=150-t.left-t.right,n=700-t.top-t.bottom,r=d3.scale.linear().domain([0,1]).range([0,a]),s=d3.scale.linear().domain([0,100]).range([n,0]),l=d3.select("#graphS3").append("svg:svg").attr("width",a+t.right+t.left).attr("height",n+t.top+t.bottom).attr("class","chart").append("g").attr("transform","translate("+t.left+","+t.top+")").attr("width",a).attr("height",n).attr("class","main"),i=d3.svg.axis().scale(r).orient("bottom").ticks(0).tickValues(0).innerTickSize(0).outerTickSize(0).tickPadding(10);l.append("g").attr("transform","translate(0,"+n+")").attr("class","main axis date").call(i);var o=d3.svg.axis().scale(s).orient("left").ticks(0).innerTickSize(0).outerTickSize(0);l.append("g").attr("transform","translate(0,0)").attr("class","main axis date").call(o);var c=d3.svg.axis().outerTickSize(0).scale(s).orient("right").ticks(0);l.append("g").attr("class","y axis").attr("transform","translate("+a+", 0)").call(c);var u=d3.svg.axis().outerTickSize(0).scale(r).orient("top").ticks(0);l.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(u);var d=[{x:0,y:0},{x:1,y:e}];l.append("svg:g").selectAll(".bar2").data(d).enter().append("rect").attr("class","bar2").attr("x",1).attr("y",function(e){return s(e.y)}).attr("width",function(e){return r(e.x)-2}).attr("height",function(e){return n-s(e.y)}),$("#yAxisLabel3").text("Ranking %'ile"),$("#percent").html("<strong>"+Math.round(10*e)/10+"%</strong>"),$("#percent").css("opacity","1.0")}function calcPercentile(e){var t,a;"female"==e?(t=maodFmean,a=maodFsd):(t=maodMmean,a=maodMsd);var n=(maod-t)/a;if(n<-4)return alert("Unable to plot percentile ranking - check input values"),0;if(n>5.5)return alert("Unable to plot percentile ranking - check input values"),0;for(var r=1,s=0,l=1,i=0,o=Math.exp(-23);Math.abs(l)>o;)s+=l=.3989422804*Math.pow(-1,i)*Math.pow(n,i)/(2*i+1)/Math.pow(2,i)*Math.pow(n,i+1)/r,r*=++i;return s+=.5,s*=100}var xInput,yInput,xs1=[],ys1=[],ny=0,nx=0,count,sumX=0,sumY=0,sumY2,sumX2,sumXY,slope=0,intercept,xFinal=[],yFinal=[],lineY1,lineY2,lineX1,workloadData=[],workloadUnits,numIntervals,intervalLength,vo2max,workrate,oxygenRequired,bodyMass,maod=0,totalTime=180,O2req,xs2=[],ys2=[],vo2MaxValues=[],sex,maodMmean=65,maodMsd=11,maodFmean=54,maodFsd=9;$(document).ready(function(){$(".x").keydown(function(e){if(13===e.which){var t=$(".x").index(this)+1;$(".x").eq(t).focus()}}),$(".y").keydown(function(e){if(13===e.which){var t=$(".y").index(this)+1;$(".y").eq(t).focus()}}),$(".y2").keydown(function(e){if(13===e.which){var t=$(".y2").index(this)+1;$(".y2").eq(t).focus()}})});
